<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partition Urbaine — Cartographie Sonore</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">

  <!-- Tailwind via CDN pour prototype rapide -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="js/collections.js"></script>
  <script src="js/script.js"></script>

  <link rel="stylesheet" href="style/main.css">

  <style>
    .layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
    }

    #map {
      width: 100%;
      height: var(--map-height-desktop);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
      overflow: hidden;
    }

    aside {
      background: rgba(30, 31, 35, 0.9);
      padding: 14px;
      border-radius: 12px;
      height: var(--map-height-desktop);
      overflow: auto;
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }

    .search {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .search input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #1e1f23;
      color: var(--rf-contrast);
    }

    .search button {
      background: var(--rf-red);
      color: white;
      border: none;
      padding: 10px 12px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .search button:hover {
      background: #ff333f;
    }

    .clip {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .clip-card {
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #333;
      background: linear-gradient(180deg, #1b1c1f, #141517);
      color: var(--rf-contrast);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .clip-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    .clip-title {
      font-weight: 700;
      color: white;
    }

    .clip-meta {
      font-size: 0.85rem;
      color: #aaa;
    }

    .clip-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border: none;

      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover {
      text-decoration: underline;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid #555;
      color: var(--rf-contrast);
      transition: border 0.2s, color 0.2s;
    }
    .btn-secondary:hover {
      border-color: var(--rf-red);
      color: var(--rf-red);
    }

    .mobile-player {
      display: none;
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      background: rgba(30,31,35,0.95);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(6px);
    }

    .mobile-player .info {
      flex: 1;
      color: var(--rf-contrast);
    }

    @media (max-width:900px) {
      .layout { grid-template-columns: 1fr; }
      aside { height: auto; order: 2; }
      #map { height: var(--map-height-mobile); }
      .mobile-player { display: flex; }
    }

    .leaflet-control-container .leaflet-top.leaflet-left {
      top: 0px;
    }
  </style>

</head>

<body> 

<div class="site-header">
  <a href="index.html" class="logo">
    <div class="brand-mark no-mobile">
      <img src="logo.png" alt="Logo Partition Urbaine" />
    </div>
    <div style="font-weight:700; font-size:1.1rem;">Partition Urbaine</div>
  </a>

  <div class="menu-toggle" onclick="document.querySelector('nav').classList.toggle('active')">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <nav>
    <a href="index.html">Accueil</a>
    <a href="rec.html">Enregistrement</a>
    <a href="#">À propos</a>
  </nav>
</div>

<main>


    <section id="derniers-audios" class="max-w-6xl mx-auto px-6 py-8 mt-3">
         <h2 class="text-3xl font-bold mb-8">Toutes les captations</h2>
      <div id="latestClips" class="grid grid-cols-1 sm:grid-cols-3 gap-6"></div>
    </section>






<script>
const sheetUrl = 'https://corsproxy.io/?https://docs.google.com/spreadsheets/d/16LhO82rFlzNwrnF6B64rKK91_Q7o0Cc9VhhuuJLu9eY/export?format=tsv&id=16LhO82rFlzNwrnF6B64rKK91_Q7o0Cc9VhhuuJLu9eY&gid=0';

let clips = [];

async function loadClips() {
  const res = await fetch(sheetUrl);
  const tsvText = await res.text();

  const lines = tsvText.trim().split('\n');

  clips = lines.map(line => {
    const [latStr, lonStr, date, heure, dureeStr, titre, description, lien, categories] = line.split('\t');

    return {
      lat: latStr && typeof latStr === 'string' ? parseFloat(latStr.replace(',', '.')) : NaN,
lon: lonStr && typeof lonStr === 'string' ? parseFloat(lonStr.replace(',', '.')) : NaN,
      date: (date && typeof date === 'string') ? date.trim() : '',
heure: (heure && typeof heure === 'string') ? heure.trim() : '',
duree: parseFloat(dureeStr),
titre: (titre && typeof titre === 'string') ? titre.trim() : '',
description: (description && typeof description === 'string') ? description.trim() : '',
lien: (lien && typeof lien === 'string') ? lien.trim() : '',
categories: (categories && typeof categories === 'string') ? stringToArray(categories.trim()) : []
    };
  });
}

// Fonction principale qui attend le chargement
async function main() {

  await loadClips(); // Attend que clips2 soit rempli

  function afficherDerniersAudios() {

  // On trie par date (puis heure) du plus récent au plus ancien
const derniers = [...clips].sort((a, b) => {
  const da = new Date(a.date.split('/').reverse().join('-') + 'T' + (a.heure || '00:00'));
  const db = new Date(b.date.split('/').reverse().join('-') + 'T' + (b.heure || '00:00'));
  return db - da;
});


  const container = document.getElementById('latestClips');
  container.innerHTML = '';

  let styleAdd = "";
  derniers.forEach((clip, idx) => {

    
    const card = document.createElement('div');
card.className = 'clip-card';

    if (clip.categories.length > 0){
      // Récupérer l'objet avec l'id 'enfance'
const itemEnfance = collections.find(item => item.id === clip.categories[0]);
// Récupérer le lien
const lienEnfance = itemEnfance ? itemEnfance.lien : null;
if(lienEnfance) {
  card.style.backgroundImage = `url(${lienEnfance})`;

}
      console.log(clip.categories[0], styleAdd);
    }

    
    card.innerHTML = `
      <div class="clip-title">${clip.titre}</div>
      <div class="clip-meta">${clip.date} • ${clip.heure} • ${clip.duree}s</div>
      <div style="margin-top:8px">${clip.description || ''}</div>
      <div class="clip-controls mt-3">
        <button class="btn play-latest" data-url="${normalizedLink(clip.lien)}">▶ Écouter</button>
      </div>
    `;
    container.appendChild(card);
  });

  // Lecture au clic
  document.querySelectorAll('.play-latest').forEach(btn => {
    btn.addEventListener('click', () => {
      const audio = document.getElementById('globalAudio');
      audio.src = btn.dataset.url;
      audio.play();
    });
  });
}

afficherDerniersAudios();
  console.log(clips); // clips2 est bien rempli ici


// simple script loader that appends to document.head
    function loadScript(src){
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = false; // preserve execution order
        s.onload = () => resolve(src);
        s.onerror = (e) => reject(new Error('Failed to load script: ' + src));
        document.head.appendChild(s);
      });
    }

    function showFatalError(message, details){
      console.error(message, details);
      const overlay = document.createElement('div');
      overlay.className = 'loader-overlay';
      overlay.innerHTML = `<div class="loader-box"><strong>${message}</strong><div style="margin-top:8px;color:#666">${details || ''}</div></div>`;
      document.body.appendChild(overlay);
    }

    // try to load leaflet + markercluster sequentially, then init
    (async function bootstrap(){
      try{
        // load Leaflet first
        await loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js');
        // then markercluster (depends on L)
        await loadScript('https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js');
        // short pause to ensure globals are set (usually unnecessary but safe)
        if(typeof L === 'undefined'){
          // give a tiny delay and re-check
          await new Promise(r=>setTimeout(r,50));
        }
        if(typeof L === 'undefined') throw new Error('Leaflet global (L) not available after loading scripts');
        initMap();
      }catch(err){
        showFatalError('Erreur : impossible de charger les bibliothèques cartographiques.', err.message || err);
      }
    })();




    function normalizedLink(url){
      if(!url) return url;
      // if it's already the uc?export=download form, return
      if(url.includes('uc?export=download')) return url;
      // match /d/<id>/ or /d/<id>$
      const m = url.match(/\/d\/([a-zA-Z0-9_-]+)(?:\/|$)/);
      if(m && m[1]) return `https://corsproxy.io/?https://drive.google.com/uc?export=download&id=${m[1]}`;
      // fallback to leaving the URL as-is
      return url;
    }

    function initMap() {
      try{
        // create map
        const map = L.map('map', { zoomControl:true, attributionControl:false }).setView([43.6,1.38], 12);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);


        const markers = L.markerClusterGroup();
        const audio = document.getElementById('globalAudio');
        let currentId = null;

        function formatDuration(sec){
          if(!sec && sec !== 0) return '0s';
          return Math.round(sec*10)/10 + 's';
        }

        function createClipCard(clip, idx){
          const div = document.createElement('div');
          div.className = 'clip-card';
          div.dataset.idx = idx;

          div.innerHTML = `
            <div class="clip-title">${escapeHtml(clip.titre)}</div>
            <div class="clip-meta">${escapeHtml(clip.date)} • ${escapeHtml(clip.heure)} • ${formatDuration(clip.duree)}</div>
            <div style="margin-top:8px">${escapeHtml(clip.description || '')}</div>
            <div class="clip-controls">
              <button class="btn play" data-idx="${idx}">Écouter</button>
              <button class="btn locate" data-idx="${idx}">Voir sur la carte</button>
            </div>
          `;/* <a class="btn-secondary" href="${escapeAttr(clip.lien)}" target="_blank" rel="noopener">Télécharger</a> */

          return div;
        }

        function addClipsToSidebar(list){
          const container = document.getElementById('clipsList');
          container.innerHTML='';
          list.forEach((clip, idx)=> container.appendChild(createClipCard(clip, idx)));

          // hook buttons
          container.querySelectorAll('.play').forEach(btn=>{
            btn.addEventListener('click', e=>{
              const i = Number(btn.dataset.idx);
              playClip(i);
            });
          });
          container.querySelectorAll('.locate').forEach(btn=>{
            const i = Number(btn.dataset.idx);
            btn.addEventListener('click', ()=>{
              const c = list[i];
              if(c) map.flyTo([c.lat,c.lon],16);
            })
          })
        }

        // add markers
        clips.forEach((clip, idx)=>{
          if(typeof clip.lat !== 'number' || typeof clip.lon !== 'number') return;


const customIcon = new L.DivIcon({
  className: 'custom-svg-icon',
  html: `
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="34" viewBox="0 0 36 50">
      <path d="M18 0C8.06 0 0 8.06 0 18c0 12.03 18 32 18 32s18-19.97 18-32C36 8.06 27.94 0 18 0z" fill="#762B84"/>
      <circle cx="18" cy="18" r="7" fill="white"/>
    </svg>
  `,
  iconSize: [36, 50],
  iconAnchor: [18, 50],
  popupAnchor: [0, -50]
});


const m = L.marker([clip.lat, clip.lon], { icon: customIcon });



          const popupContent = document.createElement('div');
          popupContent.innerHTML = `<strong>${escapeHtml(clip.titre)}</strong><br/><em>${escapeHtml(clip.date)} ${escapeHtml(clip.heure)}</em><br/><div style='margin-top:8px'>${escapeHtml(clip.description || '')}</div><div style='margin-top:8px'><button data-idx='${idx}' class='popup-play'>▶ Écouter</button></div>`;

          m.bindPopup(popupContent);

          m.on('popupopen', (e)=>{
            try{
              const btn = e.popup._contentNode && e.popup._contentNode.querySelector && e.popup._contentNode.querySelector('.popup-play');
              if(btn) btn.addEventListener('click', ()=> playClip(idx));
            }catch(err){
              console.warn('Impossible dattacher lévénement popup-play', err);
            }
          });

          markers.addLayer(m);
        });

        map.addLayer(markers);

        // Fit bounds if we have coordinates (safe handling for 1 point)
        const latlngs = clips.filter(c=>typeof c.lat === 'number' && typeof c.lon === 'number').map(c=>[c.lat,c.lon]);
        safeFitBounds(latlngs, map);

        // Play logic
        function playClip(idx){
          const clip = clips[idx];
          if(!clip) return;
          const url = normalizedLink(clip.lien);
          currentId = idx;
          audio.src = url;
          audio.play().catch(err=>{
            console.warn('Lecture bloquée par le navigateur — interaction requise',err);
          });
          // update mobile player
          document.getElementById('mp-title').textContent = clip.titre;
          document.getElementById('mp-meta').textContent = `${clip.date} • ${formatDuration(clip.duree)}`;
          document.getElementById('mobilePlayer').style.display = '';
          document.getElementById('mp-play').textContent = 'Pause';
        }

        // audio event handlers
        audio.addEventListener('ended', ()=>{
          document.getElementById('mp-play').textContent = 'Play';
        });

        document.getElementById('mp-play').addEventListener('click', ()=>{
          if(audio.paused){
            audio.play();
            document.getElementById('mp-play').textContent = 'Pause';
          } else {
            audio.pause();
            document.getElementById('mp-play').textContent = 'Play';
          }
        });

        // Search & filter
        const search = document.getElementById('search');

        function filterClips(q){
          if(!q) return clips;
          q = q.toLowerCase().trim();
          return clips.filter(c=> (c.titre||'').toLowerCase().includes(q) || (c.description||'').toLowerCase().includes(q) || (c.date||'').toLowerCase().includes(q));
        }

        search.addEventListener('input', ()=>{
          const filtered = filterClips(search.value);
          addClipsToSidebar(filtered);
        });

        // initially populate sidebar
        addClipsToSidebar(clips);

        // Accessibility: keyboard focus for popups
        map.on('popupopen', ()=>{
          const el = document.querySelector('.leaflet-popup button');
          if(el) el.focus();
        });

        // helper functions
        function safeFitBounds(lls, mapInstance){
          if(!lls || lls.length===0) return;
          if(lls.length===1) mapInstance.setView(lls[0], 14);
          else mapInstance.fitBounds(lls, {padding:[40,40]});
        }

        // micro-helpers to prevent XSS from data
        function escapeHtml(str){
          if(!str) return '';
          return String(str).replace(/[&<>\"']/g, function(s){
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s];
          });
        }
        function escapeAttr(s){ return s ? s.replace(/"/g, '&quot;') : ''; }

      }catch(err){
      }
    }
}

main();


  </script>
</main>
<footer style="padding-top: 100px; padding-bottom: 10px; text-align: center;">
  Gaël Maignan — Tous droits réservés
</footer>
</body>
</html>
